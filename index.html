<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8"> <!-- 确保中文不会乱码 -->
<link rel="icon" type="image/png" href="https://fs-im-kefu.7moor-fs1.com/ly/4d2c3f00-7d4c-11e5-af15-41bf63ae4ea0/1751729673459/logo_resized.png">
    <title>3dshootinggame</title>
    <style>
        /* 新增瞄准镜样式 */
        #crosshair {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 150;
            pointer-events: none;
        }

       .crosshair-line {
            position: absolute;
            background: rgba(255, 255, 255, 0.8);
            border: 1px solid rgba(0, 0, 0, 0.5);
        }

        #crosshair-horizontal {
            width: 20px;
            height: 2px;
            margin-left: -10px;
        }

        #crosshair-vertical {
            width: 2px;
            height: 20px;
            margin-top: -10px;
        }

        /* 原有样式 */
        body {
            margin: 0;
            overflow: hidden;
            font-family: Arial;
        }

        canvas {
            display: block;
        }

        #info {
            position: absolute;
            top: 10px;
            left: 10px;
            color: white;
            font-size: 20px;
            text-shadow: 2px 2px 2px black;
            z-index: 100;
        }

        #gameOver,
        #cover,
        #loginCover,
        #registerCover,
        #victory,
        #deleteAccountCover,
        #resetPasswordCover {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 24px;
            text-align: center;
            z-index: 200;
            background: rgba(0, 0, 0, 0.9);
            padding: 30px;
            border-radius: 15px;
            width: 80%;
            max-width: 400px;
            display: none;
            flex-direction: column;
            align-items: center;
            gap: 15px;
        }

        #cover {
            display: none;
        }

        #loginCover {
            display: flex;
        }

        button {
            padding: 12px 24px;
            font-size: 18px;
            margin-top: 20px;
            cursor: pointer;
            background: #4CAF50;
            border: none;
            color: white;
            border-radius: 5px;
            transition: background 0.3s;
        }

        button:hover {
            background: #45a049;
        }

       .error {
            color: #ff4444;
        }

        input {
            padding: 8px;
            width: 100%;
            margin: 5px 0;
            background: #333;
            border: 1px solid #444;
            color: white;
            border-radius: 4px;
        }

        #leaderboard {
            position: absolute;
            top: 60px;
            right: 10px;
            color: white;
            font-size: 14px;
            text-shadow: 1px 1px 1px black;
            background: rgba(0, 0, 0, 0.7);
            padding: 10px;
            border-radius: 5px;
            max-height: 200px;
            overflow-y: auto;
            width: 200px;
        }

       .time-entry {
            display: flex;
            justify-content: space-between;
            margin: 3px 0;
            font-size: 12px;
        }

        #userInfo {
            color: white;
            font-size: 16px;
            margin-bottom: 10px;
        }
    </style>
</head>

<body>
    <!-- 新增瞄准镜 -->
    <div id="crosshair">
        <div id="crosshair-horizontal" class="crosshair-line"></div>
        <div id="crosshair-vertical" class="crosshair-line"></div>
    </div>

    <div id="loginCover">
        <h1>用户登录</h1>
        <input type="text" id="loginUsername" placeholder="用户名">
        <input type="password" id="loginPassword" placeholder="密码">
        <button id="loginBtn">登录</button>
        <button id="guestPlayBtn">以访客身份玩</button>
        <button id="resetPasswordLink">找回密码</button> <!-- 找回密码按钮 -->
        <button id="registerBtn">注册</button>
        <div id="loginError" class="error" style="display: none;">用户名或密码错误！</div>
    </div>

    <div id="registerCover">
        <h1>用户注册</h1>
        <input type="text" id="registerUsername" placeholder="用户名">
        <input type="password" id="registerPassword" placeholder="密码">
        <button id="doRegisterBtn">完成注册</button>
        <div id="registerError" class="error" style="display: none;">用户名已存在！</div>
    </div>

    <div id="deleteAccountCover">
        <h1>注销账户</h1>
        <div>请确认您的账户信息</div>
        <input type="text" id="deleteUsername" placeholder="用户名">
        <input type="password" id="deletePassword" placeholder="密码">
        <button id="confirmDeleteBtn">确认注销</button>
        <button id="cancelDeleteBtn">取消</button>
        <div id="deleteError" class="error" style="display: none;">用户名或密码错误！</div>
    </div>

    <div id="resetPasswordCover">
        <h1>找回密码</h1>
        <input type="password" id="adminPassword" placeholder="管理员密码">
        <input type="text" id="resetUsername" placeholder="用户名">
        <button id="resetPasswordBtn">找回密码</button>
        <button id="cancelResetBtn">取消</button>
        <div id="resetError" class="error" style="display: none;">管理员密码错误或用户不存在！</div>
        <div id="resetResult" style="display: none;"></div>
    </div>

    <div id="cover">
        <h1>高速3D射击游戏</h1>
        <div id="userInfo"></div>
        <button id="startBtn">开始游戏</button>
        <button id="logoutBtn">退出登录</button>
        <button id="deleteAccountBtn">注销账户</button>
        <p>使用WASD移动，鼠标长按/短按射击，R键换弹，G键投掷手雷</p>
        <div id="webglError" class="error" style="display: none;"></div>
        <div id="leaderboard"></div>
    </div>

    <div id="info"></div>
    <div id="gameOver">
        <div>游戏结束！</div>
        <button id="restartBtn">重新开始</button>
        <button id="homeBtn">回到主界面</button>
    </div>
    <div id="victory">
        <div>胜利！你已达到10级！</div>
        <div id="victoryTime"></div>
        <button id="victoryHomeBtn">返回主页</button>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script>
        const Storage = {
            getRecords() {
                return JSON.parse(localStorage.getItem('records') || '[]');
            },
            addRecord(username, time) {
                const records = this.getRecords();
                const userRecords = records.filter(r => r.username === username);
                if (userRecords.length === 0 || time < userRecords[0].time) {
                    const newRecords = records.filter(r => r.username !== username);
                    newRecords.push({
                        username,
                        time,
                        date: new Date().toISOString()
                    });
                    localStorage.setItem('records', JSON.stringify(newRecords));
                }
            },
            getUserRecords(username) {
                return this.getRecords()
                   .filter(r => r.username === username)
                   .sort((a, b) => a.time - b.time)
                   .slice(0, 5);
            },
            getLastRecord(username) {
                const records = this.getUserRecords(username);
                return records[0];
            },
            getUsers() {
                return JSON.parse(localStorage.getItem('users') || '{}');
            },
            addUser(username, password) {
                const users = this.getUsers();
                if (users[username]) {
                    return false;
                }
                users[username] = password;
                localStorage.setItem('users', JSON.stringify(users));
                return true;
            },
            checkUser(username, password) {
                const users = this.getUsers();
                return users[username] === password;
            },
            deleteUser(username, password) {
                const users = this.getUsers();
                if (users[username] === password) {
                    delete users[username];
                    localStorage.setItem('users', JSON.stringify(users));

                    // 删除该用户的所有记录
                    const records = this.getRecords().filter(r => r.username !== username);
                    localStorage.setItem('records', JSON.stringify(records));

                    return true;
                }
                return false;
            },
            getPassword(username) {
                const users = this.getUsers();
                return users[username];
            }
        };

        const WeaponConfig = [
            {
                name: '初始手枪',
                color: 0xFF0000,
                speed: 40,
                fireRate: 600,
                damage: 12,
                ammo: 10,
                reloadTime: 2000
            },
            {
                name: '突击步枪',
                color: 0x00FF00,
                speed: 50,
                fireRate: 300,
                damage: 18,
                ammo: 30,
                reloadTime: 3000
            },
            {
                name: '激光炮',
                color: 0x0000FF,
                speed: 60,
                fireRate: 200,
                damage: 30,
                ammo: 50,
                reloadTime: 4000
            },
            {
                name: '等离子枪',
                color: 0xFF00FF,
                speed: 70,
                fireRate: 100,
                damage: 45,
                ammo: 100,
                reloadTime: 5000
            }
        ];

        const GrenadeConfig = {
            throwSpeed: 35,
            gravity: 9.8,
            explosionRadius: 20,
            fuseTime: 2000
        };

        const GameConfig = {
            player: {
                speed: 0.28,
                jump: 0.45,
                currentWeapon: 0,
                killToLevelUp: 25
            },
            enemy: {
                baseSpeed: 0.5,
                speedVariation: 0.08,
                bulletSpeed: 0.9,
                shootInterval: 600,
                spawnInterval: 400,
                bulletDamage: 12,
                meleeDamage: 0.35
            },
            maxLevel: 10
        };

        let GameState = {
            camera: null,
            scene: null,
            renderer: null,
            player: null,
            bullets: [],
            enemies: [],
            enemyBullets: [],
            grenadesArray: [],
            health: 100,
            isGameOver: false,
            spawnInterval: null,
            animationFrameId: null,
            eventListeners: {},
            enemiesDefeated: 0,
            level: 1,
            fireInterval: null,
            startTime: 0,
            lastRecord: null,
            score: 0,
            grenades: 0,
            currentAmmo: 0,
            isReloading: false,
            reloadTimeout: null,
            currentUser: null
        };

        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }

        function updateLeaderboard() {
            if (GameState.currentUser) {
                const records = Storage.getUserRecords(GameState.currentUser);
                const lbElement = document.getElementById('leaderboard');
                lbElement.innerHTML = '<h3>排行榜</h3>' + records.map((r, i) => `
                    <div class="time-entry">
                        <span>${i + 1}. ${formatTime(r.time)}</span>
                        <span>${new Date(r.date).toLocaleDateString()}</span>
                    </div>
                `).join('');
            } else {
                document.getElementById('leaderboard').innerHTML = '';
            }
        }

        function updateUserInfo() {
            const userInfo = document.getElementById('userInfo');
            if (GameState.currentUser) {
                userInfo.textContent = `当前用户: ${GameState.currentUser}`;
                document.getElementById('logoutBtn').style.display = 'block';
                document.getElementById('deleteAccountBtn').style.display = 'block';
            } else {
                userInfo.textContent = '访客模式';
                document.getElementById('logoutBtn').style.display = 'none';
                document.getElementById('deleteAccountBtn').style.display = 'none';
            }
        }

        function clearLoginForm() {
            document.getElementById('loginUsername').value = '';
            document.getElementById('loginPassword').value = '';
            document.getElementById('loginError').style.display = 'none';
        }

        document.getElementById('loginBtn').addEventListener('click', function () {
            const username = document.getElementById('loginUsername').value.trim();
            const password = document.getElementById('loginPassword').value;
            const errorDiv = document.getElementById('loginError');

            if (Storage.checkUser(username, password)) {
                document.getElementById('loginCover').style.display = 'none';
                document.getElementById('cover').style.display = 'flex';
                errorDiv.style.display = 'none';
                GameState.currentUser = username;
                GameState.lastRecord = Storage.getLastRecord(username);
                updateLeaderboard();
                document.getElementById('leaderboard').style.display = 'block';
                updateUserInfo();
            } else {
                errorDiv.style.display = 'block';
            }
        });

        document.getElementById('guestPlayBtn').addEventListener('click', function () {
            document.getElementById('loginCover').style.display = 'none';
            document.getElementById('cover').style.display = 'flex';
            GameState.currentUser = null;
            updateLeaderboard();
            document.getElementById('leaderboard').style.display = 'none';
            updateUserInfo();
            clearLoginForm();
        });

        document.getElementById('registerBtn').addEventListener('click', function () {
            document.getElementById('loginCover').style.display = 'none';
            document.getElementById('registerCover').style.display = 'flex';
            clearLoginForm();
        });

        document.getElementById('doRegisterBtn').addEventListener('click', function () {
            const username = document.getElementById('registerUsername').value.trim();
            const password = document.getElementById('registerPassword').value;
            const errorDiv = document.getElementById('registerError');

            if (Storage.addUser(username, password)) {
                document.getElementById('registerCover').style.display = 'none';
                document.getElementById('loginCover').style.display = 'flex';
                errorDiv.style.display = 'none';
                document.getElementById('loginUsername').value = username;
                document.getElementById('loginPassword').value = '';
            } else {
                errorDiv.style.display = 'block';
            }
        });

        document.getElementById('logoutBtn').addEventListener('click', function () {
            GameState.currentUser = null;
            document.getElementById('cover').style.display = 'none';
            document.getElementById('loginCover').style.display = 'flex';
            updateLeaderboard();
            document.getElementById('leaderboard').style.display = 'none';
            updateUserInfo();
            clearLoginForm();
        });

        document.getElementById('deleteAccountBtn').addEventListener('click', function () {
            document.getElementById('cover').style.display = 'none';
            document.getElementById('deleteAccountCover').style.display = 'flex';
            document.getElementById('deleteUsername').value = GameState.currentUser || '';
            document.getElementById('deletePassword').value = '';
            document.getElementById('deleteError').style.display = 'none';
        });

        document.getElementById('cancelDeleteBtn').addEventListener('click', function () {
            document.getElementById('deleteAccountCover').style.display = 'none';
            document.getElementById('cover').style.display = 'flex';
        });

        document.getElementById('confirmDeleteBtn').addEventListener('click', function () {
            const username = document.getElementById('deleteUsername').value.trim();
            const password = document.getElementById('deletePassword').value;
            const errorDiv = document.getElementById('deleteError');

            if (Storage.deleteUser(username, password)) {
                document.getElementById('deleteAccountCover').style.display = 'none';
                document.getElementById('loginCover').style.display = 'flex';
                GameState.currentUser = null;
                updateLeaderboard();
                document.getElementById('leaderboard').style.display = 'none';
                updateUserInfo();
                clearLoginForm();
            } else {
                errorDiv.style.display = 'block';
            }
        });

        document.getElementById('resetPasswordLink').addEventListener('click', function () {
            document.getElementById('cover').style.display = 'none';
            document.getElementById('resetPasswordCover').style.display = 'flex';
            document.getElementById('adminPassword').value = '';
            document.getElementById('resetUsername').value = '';
            document.getElementById('resetError').style.display = 'none';
            document.getElementById('resetResult').style.display = 'none';
        });

        document.getElementById('cancelResetBtn').addEventListener('click', function () {
            document.getElementById('resetPasswordCover').style.display = 'none';
            document.getElementById('cover').style.display = 'flex';
        });

        document.getElementById('resetPasswordBtn').addEventListener('click', function () {
            const adminPassword = document.getElementById('adminPassword').value;
            const username = document.getElementById('resetUsername').value.trim();
            const errorDiv = document.getElementById('resetError');
            const resultDiv = document.getElementById('resetResult');

            if (adminPassword === '123456') {
                const password = Storage.getPassword(username);
                if (password) {
                    resultDiv.style.display = 'block';
                    resultDiv.textContent = `用户 ${username} 的密码是: ${password}`;
                    errorDiv.style.display = 'none';
                } else {
                    errorDiv.style.display = 'block';
                    resultDiv.style.display = 'none';
                }
            } else {
                errorDiv.style.display = 'block';
                resultDiv.style.display = 'none';
            }
        });

        function checkWebGL() {
            try {
                const canvas = document.createElement('canvas');
                return !!window.WebGLRenderingContext &&
                    (canvas.getContext('webgl') || canvas.getContext('experimental-webgl'));
            } catch (e) {
                return false;
            }
        }

        function initThreeJS() {
            if (!checkWebGL()) {
                document.getElementById('webglError').innerHTML = '浏览器不支持WebGL';
                return false;
            }

            try {
                GameState.scene = new THREE.Scene();
                GameState.camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
                GameState.renderer = new THREE.WebGLRenderer({ antialias: true });
                GameState.renderer.setSize(window.innerWidth, window.innerHeight);
                document.body.appendChild(GameState.renderer.domElement);

                const ambientLight = new THREE.AmbientLight(0x404040);
                const directionalLight = new THREE.DirectionalLight(0xffffff, 1);
                directionalLight.position.set(0, 10, 5);
                GameState.scene.add(ambientLight, directionalLight);

                const ground = new THREE.Mesh(
                    new THREE.PlaneGeometry(100, 100),
                    new THREE.MeshPhongMaterial({ color: 0x228B22, side: THREE.DoubleSide })
                );
                ground.rotation.x = -Math.PI / 2;
                GameState.scene.add(ground);

                GameState.player = new THREE.Mesh(
                    new THREE.BoxGeometry(1, 2, 1),
                    new THREE.MeshPhongMaterial({ color: 0x0000ff })
                );
                GameState.player.position.set(0, 1, 0);
                GameState.camera.position.set(0, 1.6, 0);
                GameState.player.add(GameState.camera);
                GameState.scene.add(GameState.player);

                return true;
            } catch (e) {
                document.getElementById('webglError').innerHTML = `初始化失败: ${e.message}`;
                return false;
            }
        }

        function checkLevelUp() {
            if (GameState.level >= GameConfig.maxLevel) {
                showVictory();
                return;
            }

            if (GameState.enemiesDefeated >= GameConfig.player.killToLevelUp * GameState.level) {
                GameState.level++;
                GameConfig.player.currentWeapon = Math.min(WeaponConfig.length - 1, GameState.level - 1);
                updateWeapon();
                startReload();
            }
        }

        function showVictory() {
            const totalTime = Math.round((Date.now() - GameState.startTime) / 1000);
            GameState.isGameOver = true;

            document.getElementById('victoryTime').textContent = `用时: ${formatTime(totalTime)}`;
            document.getElementById('victory').style.display = 'block';
            document.exitPointerLock();

            if (GameState.currentUser) {
                Storage.addRecord(GameState.currentUser, totalTime);
                updateLeaderboard();
            }
        }

        function updateWeapon() {
            const elapsed = Math.round((Date.now() - GameState.startTime) / 1000);
            const weapon = WeaponConfig[GameConfig.player.currentWeapon];

            document.getElementById('info').innerHTML = `
                生命值: ${Math.round(GameState.health)} | 
                弹药: ${GameState.isReloading ? '装填中...' : `${GameState.currentAmmo}/${weapon.ammo}`} | 
                积分: ${GameState.score} (200分换手雷)| 
                手雷: ${GameState.grenades}<br>
                等级: ${GameState.level} | 
                武器: ${weapon.name} | 
                时间: ${formatTime(elapsed)}
                ${GameState.lastRecord ? `| 最佳记录: ${formatTime(GameState.lastRecord.time)}` : ''}
            `;
        }

        function startReload() {
            if (GameState.isReloading || GameState.currentAmmo === WeaponConfig[GameConfig.player.currentWeapon].ammo) return;

            GameState.isReloading = true;
            updateWeapon();

            const originalY = GameState.camera.rotation.x;
            const targetY = originalY + 0.3;
            const animationDuration = 500;

            const startTime = Date.now();
            const animate = () => {
                const progress = (Date.now() - startTime) / animationDuration;
                if (progress < 1) {
                    GameState.camera.rotation.x = originalY + targetY * progress;
                    requestAnimationFrame(animate);
                }
            };
            animate();

            if (GameState.reloadTimeout) clearTimeout(GameState.reloadTimeout);
            GameState.reloadTimeout = setTimeout(() => {
                GameState.currentAmmo = WeaponConfig[GameConfig.player.currentWeapon].ammo;
                GameState.isReloading = false;

                const startTime = Date.now();
                const animate = () => {
                    const progress = (Date.now() - startTime) / animationDuration;
                    if (progress < 1) {
                        GameState.camera.rotation.x = targetY - targetY * progress;
                        requestAnimationFrame(animate);
                    } else {
                        GameState.camera.rotation.x = originalY;
                    }
                };
                animate();

                updateWeapon();
            }, WeaponConfig[GameConfig.player.currentWeapon].reloadTime);
        }

        function fireWeapon(weapon) {
            if (GameState.currentAmmo <= 0) {
                startReload();
                return;
            }

            GameState.currentAmmo--;
            updateWeapon();

            GameState.camera.rotation.x += 0.03;
            setTimeout(() => {
                GameState.camera.rotation.x -= 0.03;
            }, 50);

            const bullet = new THREE.Mesh(
                new THREE.SphereGeometry(0.1),
                new THREE.MeshBasicMaterial({ color: weapon.color })
            );

            const pos = new THREE.Vector3();
            const dir = new THREE.Vector3();
            GameState.camera.getWorldPosition(pos);
            GameState.camera.getWorldDirection(dir);

            bullet.position.copy(pos);
            bullet.velocity = dir.multiplyScalar(weapon.speed);
            GameState.scene.add(bullet);
            GameState.bullets.push(bullet);
        }

        function createGrenadeModel() {
            const group = new THREE.Group();

            const cylinder = new THREE.Mesh(
                new THREE.CylinderGeometry(0.2, 0.2, 0.6, 8),
                new THREE.MeshPhongMaterial({ color: 0x8FBC8F })
            );
            cylinder.rotation.x = Math.PI / 2;

            const handle = new THREE.Mesh(
                new THREE.BoxGeometry(0.1, 0.3, 0.1),
                new THREE.MeshPhongMaterial({ color: 0xA0D8B3 })
            );
            handle.position.set(0, 0.2, 0);

            group.add(cylinder, handle);
            return group;
        }

        function throwGrenade() {
            const grenade = createGrenadeModel();
            const pos = new THREE.Vector3();
            const dir = new THREE.Vector3();

            GameState.camera.getWorldPosition(pos);
            GameState.camera.getWorldDirection(dir);

            grenade.position.copy(pos);
            grenade.velocity = dir.multiplyScalar(GrenadeConfig.throwSpeed);
            grenade.velocity.y = 8;
            grenade.startTime = Date.now();

            GameState.scene.add(grenade);
            GameState.grenadesArray.push(grenade);

            setTimeout(() => {
                explodeGrenade(grenade);
            }, GrenadeConfig.fuseTime);
        }

        function explodeGrenade(grenade) {
            const explosionPos = grenade.position.clone();

            GameState.scene.remove(grenade);
            GameState.grenadesArray = GameState.grenadesArray.filter(g => g !== grenade);

            GameState.enemies.forEach((enemy, index) => {
                if (enemy.position.distanceTo(explosionPos) < GrenadeConfig.explosionRadius) {
                    GameState.score += 5;
                    if (GameState.score >= 200) {
                        GameState.grenades += Math.floor(GameState.score / 200);
                        GameState.score %= 200;
                    }
                    GameState.enemiesDefeated++;
                    checkLevelUp();
                    GameState.scene.remove(enemy);
                    clearInterval(enemy.shootInterval);
                    GameState.enemies.splice(index, 1);
                }
            });

            updateWeapon();
        }

        function spawnEnemy() {
            if (GameState.isGameOver) return;

            const enemy = new THREE.Mesh(
                new THREE.BoxGeometry(1, 2, 1),
                new THREE.MeshPhongMaterial({ color: 0xff0000 })
            );

            enemy.position.set(
                (Math.random() - 0.5) * 50,
                1,
                (Math.random() - 0.5) * 50
            );

            const speedBoost = Math.random() * GameConfig.enemy.speedVariation;
            enemy.speed = GameConfig.enemy.baseSpeed + speedBoost;

            enemy.shootInterval = setInterval(() => {
                const bullet = new THREE.Mesh(
                    new THREE.SphereGeometry(0.15),
                    new THREE.MeshBasicMaterial({ color: 0xFFFF00 })
                );

                const predictPos = GameState.player.position.clone()
                   .add(GameState.player.getWorldDirection(new THREE.Vector3()).multiplyScalar(1.5));

                const direction = predictPos.sub(enemy.position).normalize();
                bullet.position.copy(enemy.position);
                bullet.velocity = direction.multiplyScalar(GameConfig.enemy.bulletSpeed);
                GameState.scene.add(bullet);
                GameState.enemyBullets.push(bullet);
            }, GameConfig.enemy.shootInterval);

            GameState.enemies.push(enemy);
            GameState.scene.add(enemy);
        }

        function updateGame(delta) {
            GameState.bullets.forEach((bullet, i) => {
                bullet.position.add(bullet.velocity.clone().multiplyScalar(delta / 1000));

                GameState.enemies.forEach((enemy, j) => {
                    if (bullet.position.distanceTo(enemy.position) < 1) {
                        GameState.score += 5;
                        if (GameState.score >= 200) {
                            GameState.grenades += Math.floor(GameState.score / 200);
                            GameState.score %= 200;
                        }
                        GameState.enemiesDefeated++;
                        checkLevelUp();
                        GameState.scene.remove(enemy, bullet);
                        clearInterval(enemy.shootInterval);
                        GameState.enemies.splice(j, 1);
                        GameState.bullets.splice(i, 1);
                        updateWeapon();
                    }
                });

                if (bullet.position.distanceTo(GameState.player.position) > 150) {
                    GameState.scene.remove(bullet);
                    GameState.bullets.splice(i, 1);
                }
            });

            GameState.enemyBullets.forEach((bullet, i) => {
                bullet.position.add(bullet.velocity.clone().multiplyScalar(delta / 1000 * 1.2));

                if (bullet.position.distanceTo(GameState.player.position) < 1.2) {
                    GameState.health = Math.max(0, GameState.health - GameConfig.enemy.bulletDamage);
                    updateWeapon();
                    GameState.scene.remove(bullet);
                    GameState.enemyBullets.splice(i, 1);
                    if (GameState.health <= 0) endGame();
                }

                if (bullet.position.distanceTo(GameState.player.position) > 150) {
                    GameState.scene.remove(bullet);
                    GameState.enemyBullets.splice(i, 1);
                }
            });

            GameState.enemies.forEach(enemy => {
                const direction = GameState.player.position.clone()
                   .sub(enemy.position)
                   .normalize();

                const speedMultiplier = 1 + (GameState.level * 0.1);
                enemy.position.add(direction.multiplyScalar(enemy.speed * delta / 1000 * 1.15 * speedMultiplier));

                if (enemy.position.distanceTo(GameState.player.position) < 1.8) {
                    GameState.health = Math.max(0, GameState.health - GameConfig.enemy.meleeDamage * delta);
                    updateWeapon();
                    if (GameState.health <= 0) endGame();
                }
            });

            GameState.grenadesArray.forEach((grenade, index) => {
                grenade.velocity.y -= GrenadeConfig.gravity * delta / 1000;
                grenade.position.add(grenade.velocity.clone().multiplyScalar(delta / 1000));

                if (grenade.position.y < 0.5) {
                    grenade.position.y = 0.5;
                    grenade.velocity.multiplyScalar(0.8);
                }
            });
        }

        function cleanup() {
            cancelAnimationFrame(GameState.animationFrameId);
            GameState.animationFrameId = null;

            if (GameState.fireInterval) {
                clearInterval(GameState.fireInterval);
                GameState.fireInterval = null;
            }

            if (GameState.renderer) {
                GameState.renderer.dispose();
                document.body.removeChild(GameState.renderer.domElement);
                GameState.renderer = null;
            }

            [GameState.bullets, GameState.enemyBullets, GameState.enemies, GameState.grenadesArray].forEach(arr => {
                arr.forEach(obj => {
                    if (obj.parent) obj.parent.remove(obj);
                    if (obj.geometry) obj.geometry.dispose();
                    if (obj.material) obj.material.dispose();
                    if (obj.shootInterval) clearInterval(obj.shootInterval);
                });
                arr.length = 0;
            });

            if (GameState.scene) {
                while (GameState.scene.children.length > 0) {
                    GameState.scene.remove(GameState.scene.children[0]);
                }
                GameState.scene = null;
            }

            Object.keys(GameState.eventListeners).forEach(e => {
                document.removeEventListener(e, GameState.eventListeners[e]);
            });
            GameState.eventListeners = {};
        }

        function endGame() {
            GameState.isGameOver = true;
            clearInterval(GameState.spawnInterval);
            GameState.enemies.forEach(e => clearInterval(e.shootInterval));
            document.getElementById('gameOver').style.display = 'block';
            document.exitPointerLock();
        }

        function gameLoop() {
            GameState.animationFrameId = requestAnimationFrame((timestamp) => {
                const delta = timestamp - (GameState.lastTime || timestamp);
                GameState.lastTime = timestamp;

                if (!GameState.isGameOver) {
                    updateGame(delta);
                    GameState.renderer.render(GameState.scene, GameState.camera);
                }
                gameLoop();
            });
        }

        function setupControls() {
            const controls = {
                keydown: (e) => {
                    if (GameState.isGameOver) return;
                    switch (e.key.toLowerCase()) {
                        case 'w':
                            GameState.player.translateZ(-GameConfig.player.speed);
                            break;
                        case 's':
                            GameState.player.translateZ(GameConfig.player.speed);
                            break;
                        case 'a':
                            GameState.player.translateX(-GameConfig.player.speed);
                            break;
                        case 'd':
                            GameState.player.translateX(GameConfig.player.speed);
                            break;
                        case 'r':
                            startReload();
                            break;
                        case 'g':
                            if (GameState.grenades > 0) {
                                GameState.grenades--;
                                throwGrenade();
                                updateWeapon();
                            }
                            break;
                    }
                },
                mousedown: (e) => {
                    if (GameState.isGameOver) return;
                    
                    // 请求指针锁定
                    if (!document.pointerLockElement) {
                        GameState.renderer.domElement.requestPointerLock();
                    }
                    
                    if (!GameState.fireInterval) {
                        const weapon = WeaponConfig[GameConfig.player.currentWeapon];
                        fireWeapon(weapon);
                        GameState.fireInterval = setInterval(() => {
                            fireWeapon(weapon);
                        }, weapon.fireRate);
                    }
                },
                mouseup: () => {
                    if (GameState.fireInterval) {
                        clearInterval(GameState.fireInterval);
                        GameState.fireInterval = null;
                    }
                },
                mousemove: (e) => {
                    if (document.pointerLockElement === GameState.renderer.domElement) {
                        GameState.player.rotation.y -= e.movementX * 0.002;
                        GameState.camera.rotation.x = Math.max(-Math.PI / 2, Math.min(Math.PI / 2, GameState.camera.rotation.x - e.movementY * 0.002));
                    }
                },
                pointerlockchange: () => {
                    if (document.pointerLockElement !== GameState.renderer.domElement) {
                        if (GameState.fireInterval) {
                            clearInterval(GameState.fireInterval);
                            GameState.fireInterval = null;
                        }
                    }
                }
            };

            document.addEventListener('keydown', controls.keydown);
            document.addEventListener('mousedown', controls.mousedown);
            document.addEventListener('mouseup', controls.mouseup);
            document.addEventListener('mousemove', controls.mousemove);
            document.addEventListener('pointerlockchange', controls.pointerlockchange);

            GameState.eventListeners = {
                keydown: controls.keydown,
                mousedown: controls.mousedown,
                mouseup: controls.mouseup,
                mousemove: controls.mousemove,
                pointerlockchange: controls.pointerlockchange
            };
        }

        document.getElementById('startBtn').addEventListener('click', function () {
            if (initThreeJS()) {
                document.getElementById('cover').style.display = 'none';
                GameState.isGameOver = false;
                GameState.health = 100;
                GameState.enemiesDefeated = 0;
                GameState.level = 1;
                GameState.score = 0;
                GameState.grenades = 0;
                GameState.currentAmmo = WeaponConfig[GameConfig.player.currentWeapon].ammo;
                GameState.isReloading = false;
                GameState.startTime = Date.now();
                GameState.lastRecord = GameState.currentUser ? Storage.getLastRecord(GameState.currentUser) : null;

                GameState.spawnInterval = setInterval(spawnEnemy, GameConfig.enemy.spawnInterval);
                setupControls();
                gameLoop();
                
                // 请求指针锁定
                GameState.renderer.domElement.requestPointerLock();
            }
        });

        document.getElementById('restartBtn').addEventListener('click', function () {
            cleanup();
            document.getElementById('gameOver').style.display = 'none';
            document.getElementById('startBtn').click();
        });

        document.getElementById('homeBtn').addEventListener('click', function () {
            cleanup();
            document.getElementById('gameOver').style.display = 'none';
            document.getElementById('cover').style.display = 'flex';
        });

        document.getElementById('victoryHomeBtn').addEventListener('click', function () {
            cleanup();
            document.getElementById('victory').style.display = 'none';
            document.getElementById('cover').style.display = 'flex';
        });
    </script>
</body>
</html>